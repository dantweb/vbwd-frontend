services:
  user-app:
    build:
      context: .
      dockerfile: container/user/Dockerfile
    ports:
      - "8080:80"
    environment:
      - VITE_API_URL=/api/v1
      - PLUGIN_API_SECRET=${PLUGIN_API_SECRET:-default-dev-secret-at-least-32-characters-long}
      - PLUGINS_DIR=/app/plugins
      - CORS_ORIGIN=http://localhost:8081
    volumes:
      - user-plugin-data:/app/plugins
    extra_hosts:
      - "host.docker.internal:host-gateway"

  admin-app:
    build:
      context: .
      dockerfile: container/admin/Dockerfile
      args:
        - VITE_USER_APP_URL=http://localhost:8080
        - VITE_PLUGIN_API_SECRET=${PLUGIN_API_SECRET:-default-dev-secret-at-least-32-characters-long}
    ports:
      - "8081:80"
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Development mode with hot reload
  user-dev:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./user:/app
      - ./core:/core
      - user_node_modules:/app/node_modules
    ports:
      - "5173:5173"
    command: sh -c "npm install && npm run dev -- --host"
    environment:
      - VITE_API_URL=/api/v1
    profiles:
      - dev

  admin-dev:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./admin/vue:/app
      - ./core:/core
    ports:
      - "5174:5173"
    command: sh -c "npm install && npm run dev -- --host"
    environment:
      - VITE_API_URL=/api/v1
    profiles:
      - dev

  # Test runner services
  user-test:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./user:/app
      - ./core:/core
      - user_node_modules:/app/node_modules
    command: sh -c "npm install && npm run test"
    profiles:
      - test

  user-test-watch:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./user:/app
      - ./core:/core
      - user_node_modules:/app/node_modules
    command: sh -c "npm install && npm run test:watch"
    profiles:
      - test-watch

  # Admin test runner
  admin-test:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./admin/vue:/app
      - ./core:/core
      - admin_node_modules:/app/node_modules
    command: sh -c "npm install && npm run test"
    profiles:
      - test

  # Core SDK build/test
  core-build:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./core:/app
      - core_node_modules:/app/node_modules
    command: sh -c "npm install && npm run build"
    profiles:
      - build

  core-test:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./core:/app
      - core_node_modules:/app/node_modules
    command: sh -c "npm install && npm run test"
    profiles:
      - test

volumes:
  user_node_modules:
  admin_node_modules:
  core_node_modules:
  user-plugin-data:
